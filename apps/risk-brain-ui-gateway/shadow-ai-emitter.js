/**
 * Shadow AI Emitter - Emits mock Shadow AI advisory facts to TuringCore-v3
 * 
 * CRITICAL BOUNDARIES:
 * - Shadow mode only (no execution)
 * - Advisory facts are sent to TuringCore-v3 for logging
 * - TuringCore-v3 Resolve sees them but does NOT act on them
 * - Used for board packs and regulator reports
 */

class ShadowAIEmitter {
  constructor(turingCoreUrl) {
    this.turingCoreUrl = turingCoreUrl;
    this.isRunning = false;
    this.intervalId = null;
  }

  /**
   * Start emitting mock Shadow AI advisory facts
   */
  start() {
    if (this.isRunning) {
      console.log("[ShadowAIEmitter] Already running");
      return;
    }

    console.log(`[ShadowAIEmitter] Starting mock Shadow AI advisory emission to ${this.turingCoreUrl}`);
    this.isRunning = true;

    // Emit advisory facts every 30 seconds (for demo)
    this.intervalId = setInterval(() => {
      this.emitMockAdvisory();
    }, 30000);

    // Emit one immediately
    this.emitMockAdvisory();
  }

  /**
   * Stop emitting advisory facts
   */
  stop() {
    if (this.intervalId) {
      clearInterval(this.intervalId);
      this.intervalId = null;
      this.isRunning = false;
      console.log("[ShadowAIEmitter] Stopped");
    }
  }

  /**
   * Emit a mock Shadow AI advisory fact
   */
  async emitMockAdvisory() {
    const domains = ["PAYMENTS_RL", "FRAUD", "AML", "TREASURY"];
    const entityTypes = ["PAYMENT", "DEPOSIT"];
    const recommendations = ["APPROVE", "REVIEW", "DECLINE", "HOLD"];

    const domain = domains[Math.floor(Math.random() * domains.length)];
    const entityType = entityTypes[Math.floor(Math.random() * entityTypes.length)];
    const recommendation = recommendations[Math.floor(Math.random() * recommendations.length)];
    const confidence = 0.7 + Math.random() * 0.3; // 0.7 to 1.0

    const advisory = {
      domain,
      entityType,
      entityId: entityType === "PAYMENT" ? `PAY-${this.randomId()}` : `ACC-${this.randomId()}`,
      recommendation,
      confidence,
      reasoning: this.generateReasoning(domain, recommendation),
      modelVersion: `${domain.toLowerCase()}-v1.2.3`,
      modelType: domain === "PAYMENTS_RL" ? "RL" : "RULE_BASED",
      metadata: {
        features: this.generateFeatures(domain),
        threshold: 0.75,
      },
    };

    try {
      const response = await fetch(`${this.turingCoreUrl}/api/trpc/shadowAI.add`, {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
        },
        body: JSON.stringify(advisory),
      });

      if (response.ok) {
        const result = await response.json();
        console.log(`[ShadowAIEmitter] Emitted ${domain} advisory: ${recommendation} (confidence: ${confidence.toFixed(2)})`);
      } else {
        console.error(`[ShadowAIEmitter] Failed to emit advisory: ${response.statusText}`);
      }
    } catch (error) {
      console.error(`[ShadowAIEmitter] Error emitting advisory:`, error.message);
    }
  }

  /**
   * Generate reasoning based on domain and recommendation
   */
  generateReasoning(domain, recommendation) {
    const reasonings = {
      PAYMENTS_RL: {
        APPROVE: "Payment pattern matches historical successful transactions. Low risk score.",
        REVIEW: "Payment amount exceeds typical threshold. Manual review recommended.",
        DECLINE: "Payment pattern indicates potential fraud. High risk score.",
        HOLD: "Insufficient historical data. Temporary hold for verification.",
      },
      FRAUD: {
        APPROVE: "No fraud indicators detected. Transaction velocity within normal range.",
        REVIEW: "Unusual transaction time. Geographic anomaly detected.",
        DECLINE: "Multiple fraud indicators present. Blacklisted entity involved.",
        HOLD: "Suspicious pattern detected. Awaiting additional verification.",
      },
      AML: {
        APPROVE: "Transaction below reporting threshold. No PEP match.",
        REVIEW: "Large cash transaction. Enhanced due diligence required.",
        DECLINE: "Sanctioned entity detected. OFAC match confirmed.",
        HOLD: "Structuring pattern detected. Investigation required.",
      },
      TREASURY: {
        APPROVE: "Liquidity sufficient. No concentration risk.",
        REVIEW: "Approaching exposure limit. Monitor closely.",
        DECLINE: "Liquidity constraint. Exceeds risk appetite.",
        HOLD: "Market volatility high. Defer decision.",
      },
    };

    return reasonings[domain]?.[recommendation] || "Advisory generated by Shadow AI domain.";
  }

  /**
   * Generate mock features for metadata
   */
  generateFeatures(domain) {
    const features = {
      PAYMENTS_RL: ["amount", "velocity", "geo_distance", "time_of_day"],
      FRAUD: ["device_fingerprint", "ip_reputation", "behavior_score"],
      AML: ["transaction_size", "entity_risk", "pep_score"],
      TREASURY: ["liquidity_ratio", "concentration", "var_95"],
    };

    return features[domain] || [];
  }

  /**
   * Generate random ID
   */
  randomId() {
    return Math.random().toString(36).substring(2, 10);
  }
}

export { ShadowAIEmitter };
