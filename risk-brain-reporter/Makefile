# Risk Brain Reporter â€” Makefile
#
# Author: TuringCore National Infrastructure Team
# Version: 1.0

.PHONY: build test docker helm terraform validate-templates validate-promql validate-s3-lock clean

build:
	@echo "ğŸ”¨ Building binaries..."
	go build -o bin/weekly-job ./cmd/weekly-job
	go build -o bin/api ./cmd/api
	@echo "âœ… Build complete"

test:
	@echo "ğŸ§ª Running tests..."
	go test ./test/...
	@echo "âœ… Tests complete"

docker:
	@echo "ğŸ³ Building Docker image..."
	docker build -t risk-brain-reporter:latest .
	@echo "âœ… Docker image built"

helm:
	@echo "âˆ Installing Helm chart..."
	helm upgrade --install risk-brain-reporter deploy/helm/risk-brain-reporter
	@echo "âœ… Helm chart installed"

terraform:
	@echo "ğŸ—ï¸  Applying Terraform..."
	cd deploy/terraform/risk-brain-reporter && terraform apply
	@echo "âœ… Terraform applied"

validate-templates:
	@echo "ğŸ“ Validating templates..."
	@test -f internal/renderer/templates/board.md.tmpl || (echo "âŒ Board template missing" && exit 1)
	@test -f internal/renderer/templates/regulator.md.tmpl || (echo "âŒ Regulator template missing" && exit 1)
	@echo "âœ… Templates validated"

validate-promql:
	@echo "ğŸ“Š Validating PromQL manifest..."
	@test -f internal/config/promql-map-v1.yaml || (echo "âŒ PromQL manifest missing" && exit 1)
	@echo "âœ… PromQL manifest validated"

validate-s3-lock:
	@echo "ğŸ”’ Validating S3 lock configuration..."
	@grep -q "object_lock_enabled = true" deploy/terraform/risk-brain-reporter/s3.tf || (echo "âŒ S3 object lock not enabled" && exit 1)
	@echo "âœ… S3 lock validated"

clean:
	@echo "ğŸ§¹ Cleaning..."
	rm -rf bin/
	@echo "âœ… Clean complete"
