name: BECS Orchestration Guardrails

on:
  push:
    branches:
      - master
      - main
      - develop
    paths:
      - 'core/payments/becs/**'
      - 'application/payments/becs/**'
      - 'server/becs*.test.ts'
      - 'exports/becsEvidencePack.ts'
      - '.github/workflows/becs-guardrails.yml'
  pull_request:
    branches:
      - master
      - main
      - develop
    paths:
      - 'core/payments/becs/**'
      - 'application/payments/becs/**'
      - 'server/becs*.test.ts'
      - 'exports/becsEvidencePack.ts'
      - '.github/workflows/becs-guardrails.yml'

jobs:
  becs-invariant-tests:
    name: BECS Invariant Tests (CI-Blocking)
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'
      
      - name: Install pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 9
      
      - name: Install dependencies
        run: pnpm install --frozen-lockfile
      
      - name: Run BECS Invariant Tests
        run: pnpm test becs.invariants
        timeout-minutes: 5
      
      - name: Verify test count
        run: |
          TEST_COUNT=$(pnpm test becs.invariants 2>&1 | grep -oP '\d+(?= passed)' | head -1)
          if [ "$TEST_COUNT" -lt 16 ]; then
            echo "Expected at least 16 invariant tests, found $TEST_COUNT"
            exit 1
          fi
          echo "‚úì All 16+ invariant tests passing"

  becs-replay-tests:
    name: BECS Replay Guarantee Tests (CI-Blocking)
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'
      
      - name: Install pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 9
      
      - name: Install dependencies
        run: pnpm install --frozen-lockfile
      
      - name: Run BECS Replay Tests
        run: pnpm test becs.replay
        timeout-minutes: 5
      
      - name: Verify test count
        run: |
          TEST_COUNT=$(pnpm test becs.replay 2>&1 | grep -oP '\d+(?= passed)' | head -1)
          if [ "$TEST_COUNT" -lt 6 ]; then
            echo "Expected at least 6 replay tests, found $TEST_COUNT"
            exit 1
          fi
          echo "‚úì All 6+ replay tests passing"

  becs-batch-totals-reconcile:
    name: BECS Guardrail - Batch Totals Reconcile
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Verify batch reconciliation logic exists
        run: |
          echo "Checking for batch reconciliation enforcement..."
          
          # Check assertBatchTotalsReconcile exists
          if ! grep -q "assertBatchTotalsReconcile" core/payments/becs/BECSInvariants.ts; then
            echo "‚ùå VIOLATION: assertBatchTotalsReconcile not found"
            echo "Batch totals must be reconciled"
            exit 1
          fi
          
          # Check it's used in validation
          if ! grep -q "assertBatchTotalsReconcile" core/payments/becs/BECSInvariants.ts; then
            echo "‚ùå VIOLATION: Batch reconciliation not enforced"
            exit 1
          fi
          
          echo "‚úì Batch totals reconciliation enforced"

  becs-late-returns-reverse-ledger:
    name: BECS Guardrail - Late Returns Reverse Ledger
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Verify return reversal logic exists
        run: |
          echo "Checking for return reversal enforcement..."
          
          # Check assertReturnReversesLedger exists
          if ! grep -q "assertReturnReversesLedger" core/payments/becs/BECSInvariants.ts; then
            echo "‚ùå VIOLATION: assertReturnReversesLedger not found"
            echo "Returns must reverse ledger exactly"
            exit 1
          fi
          
          # Check return only from CLEARED
          if ! grep -q "assertReturnOnlyFromCleared" core/payments/becs/BECSInvariants.ts; then
            echo "‚ùå VIOLATION: Return state guard not found"
            echo "Returns must only occur from CLEARED state"
            exit 1
          fi
          
          echo "‚úì Late return reversal enforced"

  becs-no-settlement-finality-assumptions:
    name: BECS Guardrail - No Settlement Finality Assumptions
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Block settlement finality assumptions
        run: |
          echo "Checking for settlement finality violations..."
          
          # Block "settlement is final" comments
          if grep -r "settlement.*final\|final.*settlement" core/payments/becs/ --include="*.ts"; then
            echo "‚ö†Ô∏è  WARNING: Settlement finality language detected"
            echo "BECS settlement is NOT final until return window closes"
          fi
          
          # Verify CLEARED ‚Üí RETURNED transition exists
          if ! grep -q "CLEARED.*RETURNED" core/payments/becs/BECSStateTransitions.ts; then
            echo "‚ùå VIOLATION: CLEARED ‚Üí RETURNED transition missing"
            echo "Late returns must be possible from CLEARED state"
            exit 1
          fi
          
          # Verify SETTLED is not a source state for RETURNED
          if grep -q "SETTLED.*RETURNED" core/payments/becs/BECSStateTransitions.ts; then
            echo "‚ùå VIOLATION: SETTLED ‚Üí RETURNED transition detected"
            echo "Returns cannot occur after settlement"
            exit 1
          fi
          
          echo "‚úì No settlement finality assumptions"

  becs-no-stored-state:
    name: BECS Guardrail - No Stored State
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Block stored state patterns
        run: |
          echo "Checking for stored state violations in BECS code..."
          
          # Block database writes in core/payments/becs
          if grep -r "db\.insert\|db\.update\|db\.delete" core/payments/becs/; then
            echo "‚ùå VIOLATION: Database writes detected in core/payments/becs"
            echo "BECS state must be derived from events, not stored"
            exit 1
          fi
          
          # Block balance storage
          if grep -r "storedBalance\|cachedBalance\|balanceSnapshot" core/payments/becs/; then
            echo "‚ùå VIOLATION: Stored balance detected in BECS code"
            echo "Balances must be derived from events"
            exit 1
          fi
          
          # Block mutable state
          if grep -r "let.*state\|state\s*=\|setState" core/payments/becs/*.ts; then
            echo "‚ùå VIOLATION: Mutable state detected in BECS code"
            echo "All state must be immutable"
            exit 1
          fi
          
          echo "‚úì No stored state violations detected"

  becs-no-cross-core-imports:
    name: BECS Guardrail - No Cross-Core Imports
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Block cross-core imports
        run: |
          echo "Checking for cross-core import violations..."
          
          # Block imports from other core modules
          if grep -r "from.*core/lending\|from.*core/deposits\|from.*core/exposure" core/payments/becs/; then
            echo "‚ùå VIOLATION: Cross-core imports detected in BECS code"
            echo "BECS must not depend on other core modules"
            exit 1
          fi
          
          # Block imports from application layer
          if grep -r "from.*application/lending\|from.*application/deposits" core/payments/becs/; then
            echo "‚ùå VIOLATION: Application layer imports detected in BECS core"
            echo "Core must not depend on application layer"
            exit 1
          fi
          
          # Block imports from server layer
          if grep -r "from.*server/\|from.*trpc/" core/payments/becs/; then
            echo "‚ùå VIOLATION: Server layer imports detected in BECS core"
            echo "Core must not depend on server layer"
            exit 1
          fi
          
          echo "‚úì No cross-core import violations detected"

  becs-replay-mandatory:
    name: BECS Guardrail - Replay Tests Mandatory
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Verify replay tests exist
        run: |
          echo "Verifying replay tests are present..."
          
          if [ ! -f "server/becs.replay.test.ts" ]; then
            echo "‚ùå VIOLATION: server/becs.replay.test.ts not found"
            echo "Replay tests are mandatory for BECS"
            exit 1
          fi
          
          # Check for rebuildFromEvents usage
          if ! grep -q "rebuildBECSFromEvents" server/becs.replay.test.ts; then
            echo "‚ùå VIOLATION: rebuildBECSFromEvents not used in replay tests"
            echo "Replay tests must use rebuildBECSFromEvents()"
            exit 1
          fi
          
          # Check for hash verification
          if ! grep -q "computeBECSStateHash\|sha256\|hash" server/becs.replay.test.ts; then
            echo "‚ùå VIOLATION: No hash verification in replay tests"
            echo "Replay tests must verify state hashes"
            exit 1
          fi
          
          echo "‚úì Replay tests are present and valid"

  becs-event-immutability:
    name: BECS Guardrail - Event Immutability
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Block event mutation patterns
        run: |
          echo "Checking for event mutation violations..."
          
          # Block event updates
          if grep -r "updateEvent\|modifyEvent\|editEvent" core/payments/becs/; then
            echo "‚ùå VIOLATION: Event mutation detected"
            echo "Events must be immutable (append-only)"
            exit 1
          fi
          
          # Block event deletion
          if grep -r "deleteEvent\|removeEvent\|dropEvent" core/payments/becs/; then
            echo "‚ùå VIOLATION: Event deletion detected"
            echo "Events must never be deleted"
            exit 1
          fi
          
          # Verify readonly types
          if ! grep -q "readonly" core/payments/becs/BECSPaymentEvent.ts; then
            echo "‚ö†Ô∏è  WARNING: No readonly modifiers found in BECSPaymentEvent.ts"
            echo "Consider adding readonly to enforce immutability"
          fi
          
          echo "‚úì No event mutation violations detected"

  becs-terminal-state-enforcement:
    name: BECS Guardrail - Terminal State Enforcement
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Verify terminal state guards
        run: |
          echo "Checking for terminal state enforcement..."
          
          # Check for terminal state guards in BECSInvariants.ts
          if ! grep -q "assertNotBECSTerminal\|isBECSTerminalState" core/payments/becs/BECSInvariants.ts; then
            echo "‚ùå VIOLATION: No terminal state guards found"
            echo "BECSInvariants.ts must enforce terminal state immutability"
            exit 1
          fi
          
          # Verify terminal states are defined
          if ! grep -q "SETTLED\|RETURNED\|FAILED\|EXPIRED" core/payments/becs/BECSPaymentState.ts; then
            echo "‚ùå VIOLATION: Terminal states not properly defined"
            exit 1
          fi
          
          echo "‚úì Terminal state enforcement verified"

  becs-evidence-pack-exists:
    name: BECS Guardrail - Evidence Pack Builder Exists
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Verify evidence pack builder exists
        run: |
          echo "Verifying BECS evidence pack builder..."
          
          if [ ! -f "exports/becsEvidencePack.ts" ]; then
            echo "‚ùå VIOLATION: exports/becsEvidencePack.ts not found"
            echo "Evidence pack builder is mandatory for regulatory compliance"
            exit 1
          fi
          
          # Check for required functions
          if ! grep -q "generateBECSEvidencePack" exports/becsEvidencePack.ts; then
            echo "‚ùå VIOLATION: generateBECSEvidencePack function not found"
            exit 1
          fi
          
          # Check for batch metadata
          if ! grep -q "batch.*metadata\|batchId\|fileReference" exports/becsEvidencePack.ts; then
            echo "‚ùå VIOLATION: Batch metadata not included in evidence pack"
            exit 1
          fi
          
          # Check for return information
          if ! grep -q "return.*code\|returnCode\|returnReason" exports/becsEvidencePack.ts; then
            echo "‚ùå VIOLATION: Return information not included in evidence pack"
            exit 1
          fi
          
          echo "‚úì Evidence pack builder exists and is complete"

  becs-composite-status:
    name: BECS Composite Status
    runs-on: ubuntu-latest
    needs:
      - becs-invariant-tests
      - becs-replay-tests
      - becs-batch-totals-reconcile
      - becs-late-returns-reverse-ledger
      - becs-no-settlement-finality-assumptions
      - becs-no-stored-state
      - becs-no-cross-core-imports
      - becs-replay-mandatory
      - becs-event-immutability
      - becs-terminal-state-enforcement
      - becs-evidence-pack-exists
    
    steps:
      - name: All BECS Guardrails Passed
        run: |
          echo "=================================="
          echo "BECS ORCHESTRATION: ALL CHECKS PASSED"
          echo "=================================="
          echo ""
          echo "‚úì Invariant Tests (16+)"
          echo "‚úì Replay Tests (6+)"
          echo "‚úì Batch Totals Reconcile"
          echo "‚úì Late Returns Reverse Ledger"
          echo "‚úì No Settlement Finality Assumptions"
          echo "‚úì No Stored State"
          echo "‚úì No Cross-Core Imports"
          echo "‚úì Replay Tests Mandatory"
          echo "‚úì Event Immutability"
          echo "‚úì Terminal State Enforcement"
          echo "‚úì Evidence Pack Builder Exists"
          echo ""
          echo "BECS is production-ready üöÄ"
