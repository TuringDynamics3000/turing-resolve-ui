name: Governance Checks

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]

env:
  NODE_VERSION: '20'

jobs:
  # ============================================================
  # Protocol-Only Writes Check
  # ============================================================
  protocol-writes:
    name: Protocol-Only Writes Enforcement
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Check for direct database writes
        run: |
          echo "Checking for direct database writes outside gateway..."
          
          # Define forbidden patterns
          FORBIDDEN_PATTERNS=(
            "db\.insert\("
            "db\.update\("
            "db\.delete\("
            "\.execute.*INSERT"
            "\.execute.*UPDATE"
            "\.execute.*DELETE"
          )
          
          # Define exempt paths
          EXEMPT_PATHS=(
            "server/core/gateway/"
            "server/adapters/"
            "drizzle/migrations/"
            "tests/"
            "__tests__/"
            ".spec.ts"
            ".test.ts"
          )
          
          # Build grep exclude pattern
          EXCLUDE_PATTERN=""
          for path in "${EXEMPT_PATHS[@]}"; do
            EXCLUDE_PATTERN="$EXCLUDE_PATTERN --exclude-dir=$path"
          done
          
          VIOLATIONS=0
          
          for pattern in "${FORBIDDEN_PATTERNS[@]}"; do
            echo "Checking pattern: $pattern"
            MATCHES=$(grep -rn "$pattern" server/ client/ $EXCLUDE_PATTERN --include="*.ts" --include="*.tsx" 2>/dev/null || true)
            if [ -n "$MATCHES" ]; then
              echo "❌ Found direct write pattern: $pattern"
              echo "$MATCHES"
              VIOLATIONS=$((VIOLATIONS + 1))
            fi
          done
          
          if [ $VIOLATIONS -gt 0 ]; then
            echo ""
            echo "❌ GOVERNANCE VIOLATION: Direct database writes detected outside gateway"
            echo "All writes must go through ProtocolGateway. See docs/governance/PROTOCOL_ONLY_WRITES.md"
            exit 1
          fi
          
          echo "✅ No direct database writes found outside gateway"

  # ============================================================
  # OpenAPI Contract Validation
  # ============================================================
  openapi-validation:
    name: OpenAPI Contract Validation
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Validate OpenAPI specs
        run: |
          echo "Validating OpenAPI specifications..."
          
          # Check commands.yaml exists
          if [ ! -f "server/api/openapi/commands.yaml" ]; then
            echo "❌ Missing server/api/openapi/commands.yaml"
            exit 1
          fi
          
          # Check queries.yaml exists
          if [ ! -f "server/api/openapi/queries.yaml" ]; then
            echo "❌ Missing server/api/openapi/queries.yaml"
            exit 1
          fi
          
          # Install OpenAPI validator
          npm install -g @apidevtools/swagger-cli
          
          # Validate commands spec
          echo "Validating commands.yaml..."
          swagger-cli validate server/api/openapi/commands.yaml
          
          # Validate queries spec
          echo "Validating queries.yaml..."
          swagger-cli validate server/api/openapi/queries.yaml
          
          echo "✅ OpenAPI specifications are valid"

      - name: Check API version consistency
        run: |
          echo "Checking API version consistency..."
          
          COMMANDS_VERSION=$(grep -m1 "version:" server/api/openapi/commands.yaml | awk '{print $2}')
          QUERIES_VERSION=$(grep -m1 "version:" server/api/openapi/queries.yaml | awk '{print $2}')
          
          echo "Commands API version: $COMMANDS_VERSION"
          echo "Queries API version: $QUERIES_VERSION"
          
          if [ "$COMMANDS_VERSION" != "$QUERIES_VERSION" ]; then
            echo "⚠️ Warning: API versions do not match"
          fi
          
          echo "✅ API version check complete"

  # ============================================================
  # Environment Isolation Check
  # ============================================================
  environment-isolation:
    name: Environment/IAM Isolation
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check for hardcoded credentials
        run: |
          echo "Checking for hardcoded credentials..."
          
          # Patterns that indicate hardcoded credentials
          CREDENTIAL_PATTERNS=(
            "password\s*=\s*['\"][^'\"]+['\"]"
            "api_key\s*=\s*['\"][^'\"]+['\"]"
            "secret\s*=\s*['\"][^'\"]+['\"]"
            "DATABASE_URL\s*=\s*['\"]postgres"
            "sk_live_"
            "pk_live_"
          )
          
          VIOLATIONS=0
          
          for pattern in "${CREDENTIAL_PATTERNS[@]}"; do
            echo "Checking pattern: $pattern"
            MATCHES=$(grep -rniE "$pattern" server/ client/ --include="*.ts" --include="*.tsx" --include="*.js" 2>/dev/null | grep -v "process.env" | grep -v ".example" | grep -v "test" || true)
            if [ -n "$MATCHES" ]; then
              echo "❌ Potential hardcoded credential found:"
              echo "$MATCHES"
              VIOLATIONS=$((VIOLATIONS + 1))
            fi
          done
          
          if [ $VIOLATIONS -gt 0 ]; then
            echo ""
            echo "❌ SECURITY VIOLATION: Hardcoded credentials detected"
            echo "All credentials must come from environment variables. See docs/governance/IAM_SEPARATION.md"
            exit 1
          fi
          
          echo "✅ No hardcoded credentials found"

      - name: Check for cross-environment references
        run: |
          echo "Checking for cross-environment references..."
          
          # Check for production references in non-production code
          PROD_REFS=$(grep -rn "prod-db\|production-db\|prod\.turingdynamics" server/ client/ --include="*.ts" --include="*.tsx" 2>/dev/null | grep -v "process.env" | grep -v ".md" || true)
          
          if [ -n "$PROD_REFS" ]; then
            echo "⚠️ Warning: Production references found in code (should use env vars):"
            echo "$PROD_REFS"
          fi
          
          echo "✅ Cross-environment reference check complete"

      - name: Validate environment config
        run: |
          echo "Validating environment configuration module..."
          
          if [ ! -f "server/core/environment/EnvironmentConfig.ts" ]; then
            echo "❌ Missing server/core/environment/EnvironmentConfig.ts"
            exit 1
          fi
          
          # Check that production has strict settings
          if ! grep -q "allowDirectDbAccess: false" server/core/environment/EnvironmentConfig.ts; then
            echo "❌ Production must have allowDirectDbAccess: false"
            exit 1
          fi
          
          if ! grep -q "mockExternalServices: false" server/core/environment/EnvironmentConfig.ts; then
            echo "❌ Production must have mockExternalServices: false"
            exit 1
          fi
          
          echo "✅ Environment configuration is valid"

  # ============================================================
  # Governance Documentation Check
  # ============================================================
  governance-docs:
    name: Governance Documentation
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check required governance documents
        run: |
          echo "Checking required governance documents..."
          
          REQUIRED_DOCS=(
            "docs/governance/PROTOCOL_ONLY_WRITES.md"
            "docs/governance/IAM_SEPARATION.md"
          )
          
          MISSING=0
          
          for doc in "${REQUIRED_DOCS[@]}"; do
            if [ ! -f "$doc" ]; then
              echo "❌ Missing required document: $doc"
              MISSING=$((MISSING + 1))
            else
              echo "✅ Found: $doc"
            fi
          done
          
          if [ $MISSING -gt 0 ]; then
            echo ""
            echo "❌ Missing required governance documentation"
            exit 1
          fi
          
          echo "✅ All required governance documents present"

      - name: Check OpenAPI specs exist
        run: |
          echo "Checking OpenAPI specifications..."
          
          REQUIRED_SPECS=(
            "server/api/openapi/commands.yaml"
            "server/api/openapi/queries.yaml"
          )
          
          MISSING=0
          
          for spec in "${REQUIRED_SPECS[@]}"; do
            if [ ! -f "$spec" ]; then
              echo "❌ Missing required spec: $spec"
              MISSING=$((MISSING + 1))
            else
              echo "✅ Found: $spec"
            fi
          done
          
          if [ $MISSING -gt 0 ]; then
            echo ""
            echo "❌ Missing required OpenAPI specifications"
            exit 1
          fi
          
          echo "✅ All required OpenAPI specifications present"

  # ============================================================
  # Composite Status
  # ============================================================
  governance-status:
    name: Governance Status
    needs: [protocol-writes, openapi-validation, environment-isolation, governance-docs]
    runs-on: ubuntu-latest
    if: always()
    steps:
      - name: Check all governance checks passed
        run: |
          echo "Governance Check Summary"
          echo "========================"
          echo ""
          
          if [ "${{ needs.protocol-writes.result }}" != "success" ]; then
            echo "❌ Protocol-Only Writes: FAILED"
            FAILED=1
          else
            echo "✅ Protocol-Only Writes: PASSED"
          fi
          
          if [ "${{ needs.openapi-validation.result }}" != "success" ]; then
            echo "❌ OpenAPI Validation: FAILED"
            FAILED=1
          else
            echo "✅ OpenAPI Validation: PASSED"
          fi
          
          if [ "${{ needs.environment-isolation.result }}" != "success" ]; then
            echo "❌ Environment Isolation: FAILED"
            FAILED=1
          else
            echo "✅ Environment Isolation: PASSED"
          fi
          
          if [ "${{ needs.governance-docs.result }}" != "success" ]; then
            echo "❌ Governance Docs: FAILED"
            FAILED=1
          else
            echo "✅ Governance Docs: PASSED"
          fi
          
          echo ""
          
          if [ "$FAILED" == "1" ]; then
            echo "❌ GOVERNANCE CHECKS FAILED"
            echo "See individual job logs for details"
            exit 1
          fi
          
          echo "✅ ALL GOVERNANCE CHECKS PASSED"
