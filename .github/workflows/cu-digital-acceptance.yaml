name: CU-Digital v0.1 Acceptance

on:
  push:
    branches: [ "main", "master", "release/*" ]
  pull_request:
    branches: [ "main", "master", "release/*" ]

jobs:
  cu-digital-acceptance:
    runs-on: ubuntu-latest

    env:
      TURINGCORE_BASE_URL: ${{ secrets.TURINGCORE_BASE_URL_DEV }}
      TURINGCORE_API_KEY:  ${{ secrets.TURINGCORE_API_KEY_DEV }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        working-directory: twin-orchestrator
        run: |
          pip install -r requirements.txt
          pip install -r requirements-test.txt

      - name: Run architecture compliance tests
        working-directory: twin-orchestrator
        run: |
          pytest tests/architecture/ -v

      - name: Run CU-Digital steady-state acceptance
        working-directory: twin-orchestrator/src
        run: |
          python -m cli steady-state \
            --tenant-config   ../config/tenants/cu-digital.yaml \
            --scenario-config ../config/scenarios/steady-state.yaml

      - name: Run CPS 230 Chaos Pack (optional, main branch only)
        if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master'
        working-directory: twin-orchestrator/src
        run: |
          python -m cli resilience \
            --tenant-config   ../config/tenants/cu-digital.yaml \
            --scenario-config ../config/scenarios/steady-state.yaml \
            --chaos-config    ../config/chaos/msk-outage-5min.yaml
